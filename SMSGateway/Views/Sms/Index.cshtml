@model SMSGateway.ViewModels.SmsIndexVm

<h2>SMS Dashboard</h2>

<form asp-action="Send" method="post" class="mb-3" id="smsForm" novalidate>
    <!-- Phone Number -->
    <div class="mb-2">
        <label class="form-label fw-semibold">Phone Number</label>
         <select asp-for="TemplateId" asp-items="Model.SmsTemplates" id="templateSelect" class="form-control">
                    <option value="">-- Select Template --</option>
                </select>
        <div class="invalid-feedback">Enter a valid phone number (10–15 digits).</div>
    </div>
 <div class="mb-2">
        <label class="form-label fw-semibold">Phone Number</label>
        <input type="text" name="phoneNumber" id="phoneNumber"
               placeholder="+9779812345678"
               required pattern="^\+?\d{10,15}$"
               class="form-control" />
        <div class="invalid-feedback">Enter a valid phone number (10–15 digits).</div>
    </div>

    <!-- Message -->
    <div class="mb-2">
        <label class="form-label fw-semibold">Message</label>
        <textarea name="message" id="message" placeholder="Your message..."
                  required maxlength="480"
                  class="form-control" rows="3"></textarea>

        <div class="d-flex justify-content-between">
            <small id="charCount" class="text-muted">0 / 160</small>
            <small id="smsParts" class="text-muted">(1 SMS)</small>
        </div>
        <div class="invalid-feedback">Message cannot exceed 160 characters.</div>
    </div>

    <button type="submit" class="btn btn-primary">Queue SMS</button>
</form>

<table class="table table-striped">
    <thead>
    <tr>
        <th>ID</th><th>Phone</th><th>Message</th><th>Status</th><th>SentAt</th><th>Response</th>
    </tr>
    </thead>
    <tbody>
    @foreach (var sms in Model.SmsMessages)
    {
        <tr data-id="@sms.Id">
             <td>@sms.Id</td>
                    <td>@sms.PhoneNumber</td>
                    <td>@sms.Message</td>
                    <td class="status">@sms.Status</td>
                    <td class="sent-at">@sms.SentAt?.ToString("g")</td>
                    <td class="response">@sms.Response</td>
        </tr>
    }
    </tbody>
</table>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <partial name="_ValidationScriptsPartial" />
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/smsHub")
            .build();

        connection.on("ReceiveStatusUpdate", (id, status,sentAt, response) => {
            console.log(`SMS ${id} → ${status}: ${response}`);
            const row = document.querySelector(`tr[data-id='${id}']`);
            if (row) {
                row.querySelector(".status").innerText = status;
                console.log(sentAt)
                row.querySelector(".sent-at").innerText = sentAt;
                row.querySelector(".response").innerText = response || "";
            }
        });

        connection.start().then(() => {
            console.log("SignalR connected");
        }).catch(err => console.error(err.toString()));
    </script>
    
    
        <script>
           document.addEventListener("DOMContentLoaded", () => {
               const form = document.getElementById("smsForm");
               const phoneInput = document.getElementById("phoneNumber");
               const template = document.getElementById("templateSelect");
               const msgInput = document.getElementById("message");
               const charCount = document.getElementById("charCount");
               const smsParts = document.getElementById("smsParts");
           
               msgInput.addEventListener("input", () => {
                   const len = msgInput.value.length;
                   charCount.textContent = `${len} / 160`;
           
                   // 🧮 Estimate SMS parts
                   // Each SMS = 160 chars (GSM-7 encoding)
                   // Long SMS are concatenated with ~153 chars per part
                   let parts = 1;
                   if (len <= 80) parts = 1;
                   else if (len <= 81) parts = 2;
                   // safety for 480 limit
           
                   smsParts.textContent = `(${parts} SMS)`;
           
                   // Style changes when exceeding limits
                   const overLimit = len > 160;
                   charCount.classList.toggle("text-danger", overLimit);
                   smsParts.classList.toggle("text-danger", overLimit);
               });
           
               // Bootstrap-style validation
               form.addEventListener("submit", (e) => {
                   if (!form.checkValidity()) {
                       e.preventDefault();
                       e.stopPropagation();
                   }
                   form.classList.add("was-validated");
               });
           });
        </script>
}
